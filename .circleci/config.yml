version: 2

jobs:
  test-r-3.4.4-py2:
    docker:
      - image: rocker/tidyverse:3.4.4
    steps:
      - run: |
          apt-get update
          apt-get install git ssh curl libpython-dev python-pip libffi6 libffi-dev -y
      - run: R --slave -e "install.packages('reticulate', repo = 'https://cloud.r-project.org')"
      - checkout
      - run: pip install -e .[test]
      - run: |
          export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:`R RHOME`/lib"
          pytest -s --cov=rchitect
      - run: |
          pip install codecov
          codecov
  test-r-release-py2:
    docker:
      - image: rocker/tidyverse
    steps:
      - run: |
          apt-get update
          apt-get install git ssh curl libpython-dev python-pip libffi6 libffi-dev -y
      - run: R --slave -e "install.packages('reticulate', repo = 'https://cloud.r-project.org')"
      - checkout
      - run: pip install -e .[test]
      - run: |
          export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:`R RHOME`/lib"
          pytest -s --cov=rchitect
      - run: |
          pip install codecov
          codecov
  test-r-devel-py2:
    docker:
      - image: rocker/tidyverse:devel
    steps:
      - run: |
          apt-get update
          apt-get install git ssh curl libpython-dev python-pip libffi6 libffi-dev -y
      - run: R --slave -e "install.packages('reticulate', repo = 'https://cloud.r-project.org')"
      - checkout
      - run: pip install -e .[test]
      - run: |
          export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:`R RHOME`/lib"
          pytest -s --cov=rchitect
      - run: |
          pip install codecov
          codecov
  test-r-3.4.4-py3:
    docker:
      - image: rocker/tidyverse:3.4.4
    steps:
      - run: |
          apt-get update
          apt-get install git ssh curl libpython3-dev python3-pip libffi6 libffi-dev -y
      - run: R --slave -e "install.packages('reticulate', repo = 'https://cloud.r-project.org')"
      - checkout
      - run: pip3 install -e .[test]
      - run: |
          export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:`R RHOME`/lib"
          pytest -s --cov=rchitect
      - run: |
          pip3 install codecov
          codecov
  test-r-release-py3:
    docker:
      - image: rocker/tidyverse
    steps:
      - run: |
          apt-get update
          apt-get install git ssh curl libpython3-dev python3-pip libffi6 libffi-dev -y
      - run: R --slave -e "install.packages('reticulate', repo = 'https://cloud.r-project.org')"
      - checkout
      - run: pip3 install -e .[test]
      - run: |
          export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:`R RHOME`/lib"
          pytest -s --cov=rchitect
      - run: |
          pip3 install codecov
          codecov
  test-r-devel-py3:
    docker:
      - image: rocker/tidyverse:devel
    steps:
      - run: |
          apt-get update
          apt-get install git ssh curl libpython3-dev python3-pip libffi6 libffi-dev -y
      - run: R --slave -e "install.packages('reticulate', repo = 'https://cloud.r-project.org')"
      - checkout
      - run: pip3 install -e .[test]
      - run: |
          export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:`R RHOME`/lib"
          pytest -s --cov=rchitect
      - run: |
          pip3 install codecov
          codecov
  deploy-to-pypi:
    docker:
      - image: circleci/python
    steps:
      - checkout
      - run: sudo pip install twine
      - run:
          name: init .pypirc
          command: |
            echo -e "[pypi]" >> ~/.pypirc
            echo -e "username = randy3k" >> ~/.pypirc
            echo -e "password = $PYPI_PASSWORD" >> ~/.pypirc
      - run: |
          python setup.py sdist
          twine upload dist/*
workflows:
  version: 2
  build:
    jobs:
      - test-r-3.4.4-py2:
          filters:
            tags:
              only: /^v.*/
      - test-r-release-py2:
          filters:
            tags:
              only: /^v.*/
      - test-r-devel-py2:
          filters:
            tags:
              only: /^v.*/
      - test-r-3.4.4-py3:
          filters:
            tags:
              only: /^v.*/
      - test-r-release-py3:
          filters:
            tags:
              only: /^v.*/
      - test-r-devel-py3:
          filters:
            tags:
              only: /^v.*/
      - deploy-to-pypi:
          requires:
            - test-r-3.4.4-py2
            - test-r-release-py2
            - test-r-devel-py2
            - test-r-3.4.4-py3
            - test-r-release-py3
            - test-r-devel-py3
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v.*/
